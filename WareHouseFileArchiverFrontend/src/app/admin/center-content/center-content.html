@if (view === 'items') {
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>All Items</h5>
    <button class="btn btn-success" (click)="toggleAddItemForm(true)">
        <i class="bi bi-plus-circle"></i> Add Item
    </button>
</div>

<!-- ðŸ” Item Search Input -->
<div class="mb-3">
    <input type="text" class="form-control w-50" placeholder="Search by name or category"
        (input)="onItemSearchChange($event)" />
</div>

<div class="d-flex gap-2 mb-3 flex-wrap">

    <button class="btn btn-outline-secondary btn-sm" (click)="changeSort('createdAt')">
        Sort by Time
        <i class="bi" [class.bi-sort-down]="!isDescending" [class.bi-sort-up]="isDescending"
            *ngIf="sortBy === 'createdAt'"></i>
    </button>
    <button class="btn btn-outline-secondary btn-sm" (click)="changeSort('createdBy')">
        Sort by Creator
        <i class="bi" [class.bi-sort-down]="!isDescending" [class.bi-sort-up]="isDescending"
            *ngIf="sortBy === 'createdBy'"></i>
    </button>
    <button class="btn btn-outline-secondary btn-sm" (click)="changeSort('name')">
        Sort by Name
        <i class="bi" [class.bi-sort-down]="!isDescending" [class.bi-sort-up]="isDescending"
            *ngIf="sortBy === 'name'"></i>
    </button>
</div>

@if (showEditItemForm) {
<app-edit-item [item]="selectedItemToEdit" (cancel)="showEditItemForm = false" (itemUpdated)="onItemUpdated()">
</app-edit-item>
}


@if (showAddItemForm) {
<app-add-item (cancel)="toggleAddItemForm(false)" (itemCreated)="onItemCreated()"></app-add-item>
}

@if (loading) {
<div class="text-center">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
} @else if (error) {
<div class="alert alert-danger text-center">{{ error }}</div>
} @else if (items.length === 0) {
<div class="alert alert-info text-center">No items found.</div>
} @else {
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Description</th>
                <th>Created At</th>
                <th>Created By</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @for (item of filteredItems; track item.id) {
            <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.categories?.join(', ') }}</td>
                <td>{{ item.description || '-' }}</td>
                <td>{{ item.createdAt | date: 'short' }}</td>
                <td>{{ item.createdBy || '-' }}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" (click)="toggleEditItemForm(item)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="confirmDelete(item.id)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>

            </tr>
            }
        </tbody>
    </table>
</div>
}
}



@if (view === 'users') {
<div class="d-flex justify-content-between align-items-center mb-3 gap-3 flex-wrap">
    <h5 class="mb-0">All Users</h5>

    <input type="text" class="form-control w-50" placeholder="Search by username"
        (input)="onUserSearchChange($event)" />

    <select class="form-select w-auto" (change)="onRoleFilterChange($event)">
        <option value="">All Roles</option>
        <option value="Admin">Admin</option>
        <option value="Staff">Staff</option>
    </select>
</div>

<!-- Add sorting controls for user information -->
<div class="d-flex gap-2 mb-3 flex-wrap">
    <button class="btn btn-outline-secondary btn-sm" (click)="changeUserSort('username')">
        Sort by Username
        <i class="bi" [class.bi-sort-down]="!userSortDescending" [class.bi-sort-up]="userSortDescending"
            *ngIf="userSortBy === 'username'"></i>
    </button>
    <button class="btn btn-outline-secondary btn-sm" (click)="changeUserSort('lastlogin')">
        Sort by Last Login
        <i class="bi" [class.bi-sort-down]="!userSortDescending" [class.bi-sort-up]="userSortDescending"
            *ngIf="userSortBy === 'lastlogin'"></i>
    </button>
    <button class="btn btn-outline-secondary btn-sm" (click)="changeUserSort('role')">
        Sort by Role
        <i class="bi" [class.bi-sort-down]="!userSortDescending" [class.bi-sort-up]="userSortDescending"
            *ngIf="userSortBy === 'role'"></i>
    </button>
</div>

@if (showEditUserForm) {
<app-edit-user [user]="selectedUserToEdit" (cancel)="showEditUserForm = false" (userUpdated)="onUserUpdated()">
</app-edit-user>
}

@if (showAddUserForm) {
<app-add-user (cancel)="toggleAddUserForm(false)" (userCreated)="onUserCreated()"></app-add-user>
}

<div class="mb-2">
    <button class="btn btn-success" (click)="toggleAddUserForm(true)">
        <i class="bi bi-plus-circle"></i> Add User
    </button>
</div>

@if (loading) {
<div class="text-center">
    <div class="spinner-border text-primary" role="status"></div>
</div>
} @else if (error) {
<div class="alert alert-danger text-center">{{ error }}</div>
} @else if (filteredUsers.length === 0) {
<div class="alert alert-info text-center">No matching users found.</div>
} @else {
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Last Login</th>
                <th>Login Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @for (user of filteredUsers; track user.id) {
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                    <span class="badge bg-primary me-1" *ngFor="let role of user.roles">
                        {{ role }}
                    </span>
                </td>
                <td class="login-info-cell">
                    <div class="d-flex flex-column">
                        <span class="fw-bold">{{ user.lastLoginFormatted || 'Never logged in' }}</span>
                        <small class="text-muted" *ngIf="user.daysSinceLastLogin !== null">
                            {{ user.daysSinceLastLogin }} days ago
                        </small>
                    </div>
                </td>
                <td>
                    <span class="badge login-status-badge" 
                          [class.bg-success]="user.loginStatus === 'Active today'"
                          [class.bg-warning]="user.loginStatus === 'Active yesterday'"
                          [class.bg-info]="user.loginStatus === 'Active this week'"
                          [class.bg-secondary]="user.loginStatus === 'Active this month'"
                          [class.bg-danger]="user.loginStatus === 'Inactive'"
                          [class.bg-dark]="user.loginStatus === 'Never logged in'">
                        {{ user.loginStatus }}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" (click)="toggleEditUserForm(user)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="confirmDeleteUser(user.id)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>

            </tr>
            }
        </tbody>
    </table>
</div>
}
}

@if (view === 'files') {
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h5 class="mb-0">All Files</h5>

    <input type="text" class="form-control w-50" placeholder="Search filename, item, category"
        (input)="onFileSearchChange($event)" />

    <button class="btn btn-outline-secondary btn-sm" (click)="changeFileSortOrder()">
        Sort by Time
        <i class="bi" [class.bi-sort-down]="!fileSortDescending" [class.bi-sort-up]="fileSortDescending"></i>
    </button>
</div>

<div class="mb-2 d-flex gap-2 flex-wrap">
    <button class="btn btn-success" (click)="toggleAddFileForm(true)">
        <i class="bi bi-cloud-upload"></i> Upload File
    </button>
    
    <!-- Archive Toggle Button -->
    <button class="btn btn-outline-info" (click)="toggleArchivedFiles()">
        <i class="bi bi-archive"></i> 
        {{ showArchivedFiles ? 'Hide' : 'Show' }} Archived Files
    </button>
</div>

@if (showAddFileForm) {
<app-add-file (fileUploaded)="onFileUploaded()" (cancel)="toggleAddFileForm(false)"></app-add-file>
}

<!-- Active Files Section -->
@if (!showArchivedFiles) {
@if (loading) {
<div class="text-center">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
} @else if (error) {
<div class="alert alert-danger text-center">{{ error }}</div>
} @else if (files.length === 0) {
<div class="alert alert-info text-center">No files found.</div>
} @else {
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <tbody>
            @for (category of groupedFileCategories; track category) {
            <h6 class="mt-4">{{ category }}</h6>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>File Name</th>
                            <th>Item Name</th>
                            <th>Version</th>
                            <th>Size</th>
                            <th>Created By</th>
                            <th>Created At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (file of groupedFiles[category]; track file.id) {
                        <tr>
                            <td>{{ file.fileName }}{{ file.fileExtension }}</td>
                            <td>{{ file.itemName }}</td>
                            <td>{{ file.versionNumber }}</td>
                            <td>{{ getFormattedSize(file.fileSizeInBytes) }}</td>
                            <td>{{ file.createdBy }}</td>
                            <td>{{ file.createdAt | date: 'short' }}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" (click)="onDownloadFile(file)">
                                    <i class="bi bi-download"></i>
                                </button>

                                @if (isAdmin) {
                                <button class="btn btn-sm btn-warning me-1" (click)="confirmArchiveFile(file)" 
                                        title="Archive this file">
                                    <i class="bi bi-archive"></i>
                                </button>
                                }

                                <button class="btn btn-sm btn-danger" (click)="confirmDeleteFile(file.id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }

        </tbody>
    </table>
</div>
}
}

<!-- Archived Files Section -->
@if (showArchivedFiles) {
<div class="archive-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-muted">
            <i class="bi bi-archive-fill"></i> Archived Files
            @if (isAdmin) {
                <small class="text-info">(Showing all your archived files)</small>
            } @else {
                <small class="text-warning">(Showing files archived in last 2 days)</small>
            }
        </h6>
        
        <!-- Bulk Unarchive Button for Admins -->
        @if (isAdmin) {
        <div class="archive-bulk-actions">
            @if (getUnarchivableFilesCount() > 0) {
            <button class="btn btn-success btn-sm" (click)="confirmBulkUnarchiveFiles()" 
                    title="Unarchive all your files">
                <i class="bi bi-arrow-counterclockwise"></i> 
                Unarchive All ({{ getUnarchivableFilesCount() }})
            </button>
            } 
        </div>
        }
    </div>

    @if (archiveLoading) {
    <div class="text-center">
        <div class="spinner-border text-secondary" role="status">
            <span class="visually-hidden">Loading archived files...</span>
        </div>
    </div>
    } @else if (archiveError) {
    <div class="alert alert-danger text-center">{{ archiveError }}</div>
    } @else if (archivedFiles.length === 0) {
    <div class="alert alert-info text-center">No archived files found.</div>
    } @else if (groupedArchivedFileCategories.length === 0) {
    <div class="alert alert-warning text-center">
        No archived files match your search criteria or visibility window.
    </div>
    } @else {
    <div class="table-responsive">
        <table class="table table-striped table-hover archived-files-table">
            <tbody>
                @for (category of groupedArchivedFileCategories; track category) {
                <h6 class="mt-4 text-muted">
                    <i class="bi bi-folder-fill"></i> {{ category }}
                </h6>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-secondary">
                            <tr>
                                <th>File Name</th>
                                <th>Item Name</th>
                                <th>Version</th>
                                <th>Size</th>
                                <th>Created By</th>
                                <th>Archived At</th>
                                <th>Archived Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (file of groupedArchivedFiles[category]; track file.id) {
                            <tr class="archived-file-row">
                                <td>
                                    <i class="bi bi-file-earmark-text text-muted me-1"></i>
                                    {{ file.fileName }}{{ file.fileExtension }}
                                    @if (isRecentlyArchived(file)) {
                                    <span class="badge bg-warning ms-1" title="Recently archived">New</span>
                                    }
                                </td>
                                <td>{{ file.itemName }}</td>
                                <td>{{ file.versionNumber }}</td>
                                <td>{{ getFormattedSize(file.fileSizeInBytes) }}</td>
                                <td>{{ file.createdBy }}</td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">{{ getFormattedDate(file.archivedAt) }}</span>
                                        <small class="text-muted">{{ getDaysSinceArchived(file.archivedAt) }} days ago</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary" title="{{ file.archivedReason }}">
                                        {{ file.archivedReason || 'No reason provided' }}
                                    </span>
                                </td>
                                <td>
                                    @if (canUnarchive(file)) {
                                    <button class="btn btn-sm btn-success" (click)="confirmUnarchiveFile(file)" 
                                            title="Restore this file to active status">
                                        <i class="bi bi-arrow-counterclockwise"></i> Unarchive
                                    </button>
                                    } @else {
                                    <span class="text-muted small">
                                        @if (isAdmin) {
                                        <i class="bi bi-lock"></i> Not your file
                                        } @else {
                                        <i class="bi bi-eye"></i> View only
                                        }
                                    </span>
                                    }
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
                }
            </tbody>
        </table>
    </div>
    }
</div>
}
}

@if (view === 'dashboard') {
<app-dashboard></app-dashboard>
}

@if (view === 'statistics') {
  <app-statistics></app-statistics>
}