<!-- Trash Statistics Cards -->
<div class="row mb-4" *ngIf="trashStats">
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-danger">
      <div class="card-body text-center">
        <i class="bi bi-trash3 text-danger fs-2"></i>
        <h5 class="card-title mt-2">{{ trashStats.totalTrashedFiles }}</h5>
        <p class="card-text text-muted">Total Files</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-warning">
      <div class="card-body text-center">
        <i class="bi bi-exclamation-triangle text-warning fs-2"></i>
        <h5 class="card-title mt-2">{{ trashStats.filesExpiringSoon }}</h5>
        <p class="card-text text-muted">Expiring Soon</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-info">
      <div class="card-body text-center">
        <i class="bi bi-hdd text-info fs-2"></i>
        <h5 class="card-title mt-2">{{ formatFileSize(trashStats.totalSizeInBytes) }}</h5>
        <p class="card-text text-muted">Total Size</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card border-secondary">
      <div class="card-body text-center">
        <i class="bi bi-calendar text-secondary fs-2"></i>
        <h5 class="card-title mt-2" *ngIf="trashStats.oldestFileDate">
          {{ formatDate(trashStats.oldestFileDate).split(' ')[0] }}
        </h5>
        <h5 class="card-title mt-2" *ngIf="!trashStats.oldestFileDate">N/A</h5>
        <p class="card-text text-muted">Oldest File</p>
      </div>
    </div>
  </div>
</div>

<!-- Header with Actions -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <h5 class="mb-0">
    <i class="bi bi-trash3 me-2"></i>Trash Management
  </h5>
  <button 
    class="btn btn-outline-danger" 
    (click)="confirmCleanup()"
    [disabled]="loading || !trashedFiles.length">
    <i class="bi bi-trash3"></i> Cleanup Expired Files
  </button>
</div>

<!-- Search and Filter Controls -->
<div class="row mb-3">
  <div class="col-md-6 mb-2">
    <input 
      type="text" 
      class="form-control" 
      placeholder="Search by filename, item, or deleted by..." 
      (input)="onSearchChange($event)"
      [value]="searchTerm">
  </div>
  <div class="col-md-6">
    <div class="d-flex gap-2 flex-wrap">
      <button 
        class="btn btn-outline-secondary btn-sm" 
        (click)="changeSort('deletedAt')">
        Sort by Deleted
        <i class="bi" 
           [class.bi-sort-down]="!isDescending" 
           [class.bi-sort-up]="isDescending"
           *ngIf="sortBy === 'deletedAt'"></i>
      </button>
      <button 
        class="btn btn-outline-secondary btn-sm" 
        (click)="changeSort('fileName')">
        Sort by Name
        <i class="bi" 
           [class.bi-sort-down]="!isDescending" 
           [class.bi-sort-up]="isDescending"
           *ngIf="sortBy === 'fileName'"></i>
      </button>
      <button 
        class="btn btn-outline-secondary btn-sm" 
        (click)="changeSort('daysRemaining')">
        Sort by Expiry
        <i class="bi" 
           [class.bi-sort-down]="!isDescending" 
           [class.bi-sort-up]="isDescending"
           *ngIf="sortBy === 'daysRemaining'"></i>
      </button>
    </div>
  </div>
</div>

<!-- Error Alert -->
<div class="alert alert-danger alert-dismissible fade show" role="alert" *ngIf="error">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
  <button type="button" class="btn-close" (click)="error = ''" aria-label="Close"></button>
</div>

<!-- Loading Spinner -->
<div class="text-center my-4" *ngIf="loading">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2 text-muted">Loading trashed files...</p>
</div>

<!-- Trash Files Table -->
<div class="table-responsive" *ngIf="!loading">
  <table class="table table-hover" *ngIf="filteredTrashedFiles.length > 0">
    <thead class="table-dark">
      <tr>
        <th scope="col">
          <i class="bi bi-file-earmark me-1"></i>File Name
        </th>
        <th scope="col" class="d-none d-md-table-cell">
          <i class="bi bi-box me-1"></i>Item
        </th>
        <th scope="col" class="d-none d-lg-table-cell">
          <i class="bi bi-hdd me-1"></i>Size
        </th>
        <th scope="col">
          <i class="bi bi-calendar me-1"></i>Deleted
        </th>
        <th scope="col" class="d-none d-md-table-cell">
          <i class="bi bi-person me-1"></i>By
        </th>
        <th scope="col">
          <i class="bi bi-clock me-1"></i>Expires
        </th>
        <th scope="col">
          <i class="bi bi-gear me-1"></i>Actions
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let file of filteredTrashedFiles; trackBy: trackByFileId">
        <td>
          <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark-text text-primary me-2"></i>
            <div>
              <div class="fw-medium">{{ file.fileName }}</div>
              <small class="text-muted">v{{ file.versionNumber }}</small>
            </div>
          </div>
        </td>
        <td class="d-none d-md-table-cell">
          <span class="badge bg-secondary" *ngIf="file.itemName">{{ file.itemName }}</span>
          <span class="text-muted" *ngIf="!file.itemName">No Item</span>
        </td>
        <td class="d-none d-lg-table-cell">{{ formatFileSize(file.fileSizeInBytes) }}</td>
        <td>
          <small>{{ formatDate(file.deletedAt) }}</small>
        </td>
        <td class="d-none d-md-table-cell">
          <small>{{ file.deletedBy }}</small>
        </td>
        <td>
          <span [class]="getDaysRemainingClass(file.daysRemaining)">
            {{ file.daysRemaining }} day{{ file.daysRemaining !== 1 ? 's' : '' }}
          </span>
        </td>
        <td>
          <div class="btn-group" role="group">
            <button 
              class="btn btn-outline-success btn-sm" 
              (click)="confirmRestore(file)"
              [disabled]="!file.canRestore"
              title="Restore File">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button 
              class="btn btn-outline-danger btn-sm" 
              (click)="confirmPermanentDelete(file)"
              title="Permanently Delete">
              <i class="bi bi-trash3"></i>
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empty State -->
  <div class="text-center py-5" *ngIf="filteredTrashedFiles.length === 0 && !loading">
    <i class="bi bi-trash3 text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">No files in trash</h4>
    <p class="text-muted" *ngIf="searchTerm">
      No files match your search criteria. Try a different search term.
    </p>
    <p class="text-muted" *ngIf="!searchTerm">
      Deleted files will appear here and be automatically removed after 7 days.
    </p>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade show d-block" *ngIf="showConfirmDialog" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          Confirm Action
        </h5>
        <button type="button" class="btn-close" (click)="cancelAction()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="confirmAction === 'restore'">
          <p>Are you sure you want to restore <strong>{{ selectedFile?.fileName }}</strong>?</p>
          <p class="text-muted small">The file will be moved back to its original location.</p>
        </div>
        <div *ngIf="confirmAction === 'permanentDelete'">
          <p class="text-danger">Are you sure you want to <strong>permanently delete</strong> <strong>{{ selectedFile?.fileName }}</strong>?</p>
          <p class="text-muted small">This action cannot be undone. The file will be completely removed from the system.</p>
        </div>
        <div *ngIf="confirmAction === 'cleanup'">
          <p>Are you sure you want to cleanup all expired files from trash?</p>
          <p class="text-muted small">This will permanently delete all files that have been in trash for more than 7 days.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
        <button 
          type="button" 
          class="btn"
          [class.btn-success]="confirmAction === 'restore'"
          [class.btn-danger]="confirmAction === 'permanentDelete' || confirmAction === 'cleanup'"
          (click)="executeAction()"
          [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          <span *ngIf="confirmAction === 'restore'">
            <i class="bi bi-arrow-clockwise me-1"></i>Restore
          </span>
          <span *ngIf="confirmAction === 'permanentDelete'">
            <i class="bi bi-trash3 me-1"></i>Permanently Delete
          </span>
          <span *ngIf="confirmAction === 'cleanup'">
            <i class="bi bi-trash3 me-1"></i>Cleanup
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
